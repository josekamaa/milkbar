<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M-Pesa Payment & WhatsApp Order</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    .product { margin-bottom: 10px; }
    input { margin: 5px 0; padding: 8px; width: 250px; }
    button { padding: 10px 20px; margin: 10px 0; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .total { font-weight: bold; margin: 15px 0; }
  </style>
</head>
<body>

  <h1>Order Products</h1>

  <div id="products"></div>

  <div class="total">Total: Ksh <span id="total">0</span></div>

  <input type="text" id="name" placeholder="Your Name"><br>
  <input type="text" id="phone" placeholder="M-Pesa Phone (e.g., 0712345678)"><br>

  <button id="payBtn">1. Pay with M-Pesa</button><br>
  <button id="whatsappBtn" disabled>2. Send Order via WhatsApp</button>

  <script>
    // Products list
    const products = [
      { id: 1, name: "Product A", price: 100 },
      { id: 2, name: "Product B", price: 200 },
      { id: 3, name: "Product C", price: 300 }
    ];

    let cart = [];
    let total = 0;
    const productsDiv = document.getElementById("products");
    const totalSpan = document.getElementById("total");
    const payBtn = document.getElementById("payBtn");
    const whatsappBtn = document.getElementById("whatsappBtn");

    // Render products
    products.forEach(product => {
      const div = document.createElement("div");
      div.className = "product";
      div.innerHTML = `
        <label>
          <input type="checkbox" value="${product.id}">
          ${product.name} - Ksh ${product.price}
        </label>
      `;
      productsDiv.appendChild(div);
    });

    // Update cart
    productsDiv.addEventListener("change", (e) => {
      const productId = parseInt(e.target.value);
      const product = products.find(p => p.id === productId);

      if (e.target.checked) {
        cart.push(product);
      } else {
        cart = cart.filter(p => p.id !== productId);
      }

      total = cart.reduce((sum, p) => sum + p.price, 0);
      totalSpan.textContent = total;
    });

    // Handle payment
    payBtn.addEventListener("click", async () => {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();

      if (!name || !/^0[17]\d{8}$/.test(phone)) {
        alert("Please enter a valid name and phone number (e.g., 0712345678 or 0112345678)");
        return;
      }

      if (cart.length === 0) {
        alert("Please select at least one product.");
        return;
      }

      payBtn.disabled = true;
      payBtn.textContent = "Processing Payment...";

      try {
        const res = await fetch("/api/stkpush", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount: total, phone, name, cart })
        });

        const data = await res.json();

        if (res.ok) {
          alert("Payment request sent. Check your M-Pesa phone.");
          whatsappBtn.disabled = false; // enable WhatsApp after payment
        } else {
          alert("Payment failed: " + data.error);
        }
      } catch (error) {
        alert("Error: " + error.message);
      } finally {
        payBtn.disabled = false;
        payBtn.textContent = "1. Pay with M-Pesa";
      }
    });

    // Handle WhatsApp order
    whatsappBtn.addEventListener("click", () => {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();

      let message = `Order from ${name} (${phone})%0A%0A`;
      cart.forEach(p => {
        message += `- ${p.name} - Ksh ${p.price}%0A`;
      });
      message += `%0ATotal: Ksh ${total}`;

      const whatsappUrl = `https://wa.me/254711391662?text=${message}`;
      window.open(whatsappUrl, "_blank");
    });
  </script>

</body>
</html>
